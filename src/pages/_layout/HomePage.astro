---
import { Image } from "astro:assets";
import type { Entry } from "contentful";
import { MiniCard } from "~components/Course/MiniCard";
import { Leaderboard } from "~components/Leaderboard";
import { RichText } from "~components/RichText";
import { ResponsiveHeadline } from "~components/ResponsiveHeadline";
import { MdGolfCourse } from "react-icons/md";
import Layout from "~layouts/Layout.astro";
import { contentfulClient } from "~services/contentful/contentful";
import { contentfulCache } from "~utils/contentfulCache";
import heroBg from "~/assets/admiral-baker-south-bg.webp";
import type {
	TypeCourseSkeleton,
	TypeLeadersSkeleton,
	TypeSimplePageSkeleton,
} from "~types/contentful";
import type { TypeTournamentSkeleton } from "~types/contentful/TypeTournament";
import type { TypeUpdateDateSkeleton } from "~types/contentful/TypeUpdateDate";

import * as styles from "./HomePage.css";

// Fetch all data in parallel for faster initial load
const [entries, courseEntries, leaders, updateDate] = await Promise.all([
	// Fetch simplePage entries
	contentfulCache.cached(
		async () =>
			contentfulClient.getEntries<TypeSimplePageSkeleton>({
				content_type: "simplePage",
				"fields.title": "Home",
				limit: 1,
			}),
		{ content_type: "simplePage", title: "Home" },
		15 * 60 * 1000, // 15 minutes cache for static home content
	),
	// Fetch course and tournament data
	contentfulCache.cached(
		async () =>
			contentfulClient.getEntries<TypeCourseSkeleton>({
				content_type: "course",
				include: 2,
				limit: 100,
			}),
		{ content_type: "course", page: "home" },
		10 * 60 * 1000, // 10 minutes cache
	),
	// Fetch leaders data
	contentfulCache.cached(
		async () =>
			contentfulClient.getEntries<TypeLeadersSkeleton>({
				content_type: "leaders",
				limit: 300,
			}),
		{ content_type: "leaders", page: "home" },
		10 * 60 * 1000, // 10 minutes cache
	),
	// Fetch update date for leaderboards
	contentfulCache.cached(
		async () =>
			contentfulClient.getEntries<TypeUpdateDateSkeleton>({
				content_type: "updateDate",
				"fields.title": "Leaderboards",
				limit: 1,
			}),
		{ content_type: "updateDate", title: "Leaderboards" },
		10 * 60 * 1000, // 10 minutes cache
	),
]);

const today = new Date();
today.setHours(0, 0, 0, 0); // Set time to 00:00:00

// Find the first upcoming tournament date
const upcomingTournament = courseEntries.items
	.flatMap((course) => course.fields.tournaments ?? []) // Flatten all tournaments
	.filter(
		(tournament): tournament is Entry<TypeTournamentSkeleton, undefined, string> =>
			tournament &&
			"fields" in tournament &&
			tournament.fields.date &&
			new Date(tournament.fields.date) >= today, // Compare with normalized date
	)
	.sort(
		(a, b) => new Date(a.fields.date).getTime() - new Date(b.fields.date).getTime(), // Sort by date ascending
	)[0]; // Get the earliest upcoming tournament

// Extract relevant data
const tournamentDate = upcomingTournament?.fields.date ?? "TBD";
const tournamentPrices = upcomingTournament?.fields.prices ?? [];
const tournamentPlayers = upcomingTournament?.fields.players ?? "N/A";
const tournamentInclusions = upcomingTournament?.fields.inclusions ?? [];
const courseName =
	courseEntries.items.find((course) =>
		course.fields.tournaments?.some((tournament) => tournament === upcomingTournament),
	)?.fields.course ?? "Unknown Course";

const courseSlug = courseEntries.items.find((course) =>
	course.fields.tournaments?.some((tournament) => tournament === upcomingTournament),
)?.fields.slug;

const leaderItems = leaders.items;

// Check if three rounds check is enabled (from Contentful field)
const threeRoundsCheck = leaderItems.some((leader) => leader.fields.threeRoundsCheck === true);

// Extract update date for leaderboards
const leaderboardsUpdateDate = updateDate.items[0]?.fields.date
	? (() => {
			const dateStr = updateDate.items[0].fields.date;
			const [year, month, day] = dateStr.split("-");
			return `${parseInt(month)}/${parseInt(day)}/${year.slice(-2)}`;
		})()
	: null;
---

<Layout
	title="UCSD Casual Golf Club | San Diego Golf Tournaments & Community"
	description="UCSD Casual Golf Club - monthly tournaments & camaraderie for UCSD faculty, staff, students, alumni & friends. All handicap levels welcome. Join today!"
>
	<div class={styles.homeWrapper}>
		<section class={styles.homeHero}>
			<Image
				src={heroBg}
				alt="Admiral Baker South Golf Course background"
				class={styles.heroImage}
				loading="eager"
				fetchpriority="high"
				widths={[640, 1024, 1920]}
				sizes="100vw"
			/>
			<div class={styles.heroContent}>
				<MiniCard
					title={"Upcoming Tournament"}
					date={tournamentDate}
					prices={tournamentPrices}
					players={tournamentPlayers}
					inclusions={tournamentInclusions}
					course={courseName}
					isCoursePage={false}
					slug={courseSlug}
					label="Details"
				/>
			</div>
		</section>
		<section class={styles.homeColWrapper}>
			{
				entries.items.map((item) => (
					<section class={styles.leftCol}>
						{item.fields.content && <RichText richText={item.fields.content} />}
					</section>
				))
			}
			<section class={styles.rightCol}>
				{
					threeRoundsCheck ? (
						<>
							<ResponsiveHeadline className={styles.rightColTitle} size={4} as="h2">
								Leaderboards
							</ResponsiveHeadline>
							<p>Last Updated: {leaderboardsUpdateDate}</p>
							<Leaderboard items={leaderItems} gross />
							<Leaderboard items={leaderItems} net firstFlight />
							<Leaderboard items={leaderItems} net secondFlight />

							<p>* Has not played a minimum of 5 rounds</p>
						</>
					) : (
						<div class={styles.rightColCard}>
							<ResponsiveHeadline className={styles.rightColCardTitle} size={4} as="h2">
								Leaderboards
							</ResponsiveHeadline>
							<div class={styles.rightColCardInfo}>
								<MdGolfCourse size={48} />
								<p>Will show when players complete 3 rounds.</p>
							</div>
						</div>
					)
				}
			</section>
		</section>
	</div>
</Layout>
