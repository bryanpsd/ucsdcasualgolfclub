---
import "~/styles/globals/global.css";
import "~/styles/globals/reset.css";
import "~/styles/globals/theme.css";

import { Hero } from "~components/Hero";
import { Player as PlayerComponent } from "~components/Player";

import Layout from "~layouts/Layout.astro";
import { contentfulClient } from "~services/contentful/contentful";
import { contentfulCache } from "~utils/contentfulCache";
import { transformPlayerResults } from "~utils/contentfulTransformers";

import * as styles from "~styles/globals/common.css";
import type { TypeLeadersSkeleton } from "~types/contentful";

const entries = await contentfulCache.cached(
	async () =>
		contentfulClient.getEntries<TypeLeadersSkeleton>({
			content_type: "leaders",
			include: 2,
			limit: 1000,
		}),
	{ content_type: "leaders", page: "results" },
	10 * 60 * 1000, // 10 minutes cache
);

const players = transformPlayerResults(entries.items);

const url = new URL(Astro.request.url);
const selectedPlayer = url.searchParams.get("playerName") || "";
const currentPlayer = players.find((p) => p.playerName === selectedPlayer);
const isOnCurrentRoster = currentPlayer?.onCurrentRoster ?? false;
---

<Layout
	title={`${selectedPlayer} ${isOnCurrentRoster ? "Stats & " : ""}Results | UCSD Casual Golf Club`}
	description={`View ${selectedPlayer}'s tournament results, scores, and performance history with the UCSD Casual Golf Club.`}
>
	<Hero title={`${selectedPlayer} ${isOnCurrentRoster ? "Stats & " : ""}Results`} />
	<div class={styles.subPageWrapper}>
		<PlayerComponent players={players} initialSelectedPlayer={selectedPlayer} client:idle />
	</div>
</Layout>
