---
import "~/styles/globals/global.css";
import "~/styles/globals/reset.css";
import "~/styles/globals/theme.css";

import { Hero } from "~components/Hero";
import { Table } from "~components/Table";

import Layout from "~layouts/Layout.astro";
import { contentfulClient } from "~services/contentful/contentful";
import { contentfulCache } from "~utils/contentfulCache";
import { transformRosterPlayers } from "~utils/contentfulTransformers";
import * as commonStyles from "~styles/globals/common.css";
import type { TypeRosterSkeleton } from "~types/contentful/TypeRoster";

const entries = await contentfulCache.cached(
	async () =>
		contentfulClient.getEntries<TypeRosterSkeleton>({
			content_type: "roster",
			include: 2,
		}),
	{ content_type: "roster", page: "index" },
	10 * 60 * 1000, // 10 minutes cache
);

const currentRosterPlayers = transformRosterPlayers(entries.items);

const lastUpdated = entries.items
	.map((item) => new Date(item.sys.updatedAt))
	.sort((a, b) => b.getTime() - a.getTime())[0]
	?.toLocaleDateString("en-US", {
		year: "2-digit",
		month: "2-digit",
		day: "2-digit",
	});

// Helper function to build player URL
const buildPlayerUrl = (playerName: string) => {
	const params = new URLSearchParams({ playerName });
	return `/roster/player?${params.toString()}`;
};

// Create table data with serializable link configuration
const tableData = currentRosterPlayers.map((player) => [
	{
		value: player?.playerName || "Unknown",
		href: buildPlayerUrl(player?.playerName || ""),
		isLink: true,
		linkProps: {
			track: true,
			trackLabel: player?.playerName || "Unknown",
			trackCategory: "roster_interaction",
			trackParams: { player_handicap: player?.handicapIndex ?? 0 },
			variant: "navy" as const,
		},
	},
	player?.handicapIndex === undefined ? "NH" : String(player.handicapIndex),
]);
---

<Layout
	title="Club Roster | UCSD Casual Golf Club Members List"
	description="Meet the members of the UCSD Casual Golf Club. View our roster and connect with fellow San Diego golf enthusiasts."
>
	<Hero title="UCSD Casual Golf Club Roster" />
	<div class={commonStyles.subPageWrapper}>
		<div style="overflow-x: auto;">
			<Table
				client:idle
				thead={[
					"Player",
					`Index (as of: ${lastUpdated ?? "Unknown"}
				)`,
				]}
				tbody={tableData}
				track={true}
				trackLabel="Roster Table"
				trackCategory="roster_interaction"
			/>
		</div>
	</div>
</Layout>
