---
import { contentfulClient } from '../../lib/contentful';
import type { TypeCourseSkeleton } from '../../types/contentful';

import Layout from '../../layouts/Layout.astro';

import { CourseCard } from '../../components/Course/CourseCard';
import { ResponsiveHeadline } from '~components/ResponsiveHeadline';

import * as styles from '~styles/common.css';

const entries = await contentfulClient.getEntries<TypeCourseSkeleton>({
  content_type: 'course',
});

const getTournaments = entries.items
  .flatMap((item) => {
    return item.fields.tournaments?.map((tournament) => {
      if (
        tournament &&
        'fields' in tournament &&
        tournament.fields.date &&
        new Date(tournament.fields.date) > new Date('2024-12-05')
      ) {
        return {
          ...item.fields,
          tournaments: [
            {
              prices: tournament.fields.prices,
              date: tournament.fields.date,
              players: tournament.fields.players,
              amenities: tournament.fields.amenities,
              coursePar: tournament.fields.coursePar,
              mensTees: tournament.fields.mensTees,
              womensTees: tournament.fields.womensTees,
              results:
                tournament.fields.results &&
                'fields' in tournament.fields.results
                  ? (tournament.fields.results.fields.file?.url ?? null)
                  : null,
              clubChampionship: tournament.fields.clubChampionship ?? false,
            },
          ],
        };
      }
      return null;
    });
  })
  .filter(Boolean)
  .sort(
    (a, b) =>
      new Date(a?.tournaments?.[0]?.date ?? 0).getTime() -
      new Date(b?.tournaments?.[0]?.date ?? 0).getTime()
  );

const getCurrentYear = new Date().getFullYear();
---

<Layout>
  <section class={styles.heroWrapper}>
    <ResponsiveHeadline size={3} as="h1"
      >{getCurrentYear} Tournaments</ResponsiveHeadline
    >
  </section>
  <div class={styles.subPageWrapper}>
    {
      getTournaments.map((item) => (
        <CourseCard
          client:load
          date={item?.tournaments[0].date}
          clubChampionship={item?.tournaments[0].clubChampionship}
          course={item?.course}
          prices={item?.tournaments[0].prices}
          players={item?.tournaments[0].players}
          slug={item?.slug}
          amenities={item?.tournaments[0].amenities}
          results={item?.tournaments[0].results}
          mensTees={item?.tournaments[0].mensTees}
          womensTees={item?.tournaments[0].womensTees}
          coursePar={item?.tournaments[0].coursePar}
        />
      ))
    }
  </div>
</Layout>
