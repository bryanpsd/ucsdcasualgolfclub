---
import { format } from "date-fns";
import { FaFilePdf } from "react-icons/fa";
import { Button } from "~components/Button";
import { ResponsiveHeadline } from "~components/ResponsiveHeadline";
import { CourseDetails } from "../CourseDetails";
import { CourseInclusions } from "../CourseInclusions";
import * as styles from "./MiniCard.css";

const {
  title,
  course,
  prices,
  players,
  date,
  isCoursePage,
  courseWebsite,
  address,          
  label,
  slug,
  results,
  inclusions,
  type,
  tournamentNotes,
} = Astro.props;

const validDate = date && !Number.isNaN(Date.parse(date)) ? new Date(date) : null;

const rawAddress = (() => {
  if (!address) return "";
  if (typeof address === "string") return address.trim();
  if (typeof address === "object") {
    const lat = address.lat ?? address.latitude;
    const lon = address.lon ?? address.lng ?? address.longitude;
    if (typeof lat === "number" && typeof lon === "number") return `${lat},${lon}`;
    const line1 = address.addressLine1 || address.line1 || address.street || "";
    const line2 = address.addressLine2 || address.line2 || address.street2 || "";
    const city  = address.city || "";
    const state = address.state || address.region || "";
    const zip   = address.zip || address.postalCode || "";
    return [line1, line2, [city, state].filter(Boolean).join(", "), zip]
      .filter(Boolean)
      .join(", ")
      .replace(/,\s*,/g, ", ")
      .replace(/,\s*$/,"")
      .trim();
  }
  return "";
})();

const isCoords = /^-?\d+(\.\d+)?,-?\d+(\.\d+)?$/.test(rawAddress);
const encodedAddress = rawAddress
  ? (isCoords ? rawAddress : encodeURIComponent(rawAddress))
  : "";

const onCoursePage = Boolean(isCoursePage);
const hasStaticAddress = rawAddress.length > 0;
const hasResults = Boolean(results && typeof results === "object" && results?.fields?.file?.url);

const showDirectionsButton = onCoursePage && !hasResults;

const staticHref = hasStaticAddress
  ? (isCoords
      ? `https://www.google.com/maps/search/?api=1&query=${rawAddress}`
      : `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`)
  : "#";

const mapsApiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY || "";
---
<div class={styles.miniCardWrapper} data-has-address={hasStaticAddress}>
  <ResponsiveHeadline className={styles.miniCardTitle} size={4} as="h2">
    {title}
  </ResponsiveHeadline>

  <div class={styles.miniCard}>
    <ResponsiveHeadline className={styles.miniCardCourse} size={4} as="h3">
      {course?.fields?.name || course?.name || course}
    </ResponsiveHeadline>

    {tournamentNotes && tournamentNotes.length > 0 && (
      <div class={styles.tournamentNotes}>
        {tournamentNotes.map((note: string) => (
          <ResponsiveHeadline size={4} as="h4">{note}</ResponsiveHeadline>
        ))}
      </div>
    )}

    <div class={styles.dateTimeTypeWrapper}>
      {validDate ? (
        <>
          <div class={styles.dateTimeWrapper}>
            <span>{format(date, "E M/d/yy")}</span>@<span>{format(date, "h:mmaaa")}</span>
          </div>
          {type && <div>{type}</div>}
        </>
      ) : (
        <span>Date not available</span>
      )}
    </div>

    {(prices || players) && (
      <CourseDetails client:load prices={prices} players={players} isMiniCard />
    )}

    {onCoursePage && inclusions && inclusions.length > 0 && (
      <CourseInclusions client:load tournament={{ inclusions }} isMiniCard />
    )}

    {hasResults ? (
      <Button
        as="a"
        variant="outlined"
        color="secondary"
        size="small"
        target="_blank"
        rel="noopener noreferrer"
        href={results.fields.file.url}
      >
        <span class={styles.resultsIconWrapper}>
          <FaFilePdf className={styles.resultsIcon} aria-hidden="true" />
          <span>Results</span>
        </span>
      </Button>
    ) : (
      <Button
        variant="outlined"
        color="secondary"
        as="a"
        size="small"
        rel={onCoursePage ? "noopener noreferrer" : ""}
        target={onCoursePage ? "_blank" : "_self"}
        href={
          onCoursePage
            ? courseWebsite
            : `/tournaments/${format(new Date(date as string), "yyyy")}/${slug}`
        }
      >
        {label}
      </Button>
    )}

    {showDirectionsButton && (
      <Button
        id="driving-directions-btn"
        variant="outlined"
        color="secondary"
        as="a"
        size="small"
        rel="noopener noreferrer"
        target="_blank"
        href={staticHref}
        data-static={hasStaticAddress ? "true" : "false"}
        data-raw={rawAddress}
        data-is-coords={isCoords ? "true" : "false"}
        data-api-key={mapsApiKey}
      >
        Driving Directions
      </Button>
    )}

    {showDirectionsButton && !hasStaticAddress && (
      <p id="directions-status" style="font-size:.7rem;opacity:.65;margin-top:.5rem;">
        Finding nearest golf course…
      </p>
    )}
  </div>
</div>

{showDirectionsButton && (
  <script is:inline>
    (() => {
      const btn = document.getElementById("driving-directions-btn");
      if (!btn) return;
      const statusEl = document.getElementById("directions-status");
      const hasStatic = btn.getAttribute("data-static") === "true";
      const apiKey = btn.getAttribute("data-api-key") || "";

      const adaptPlatform = () => {
        const ua = navigator.userAgent.toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(ua);
        const href = btn.getAttribute("href");
        if (!href || href === "#") return;
        if (isIOS) {
          const match = href.match(/query=([^&]+)/);
          const q = match ? decodeURIComponent(match[1]) : "golf course";
          btn.setAttribute("href", "https://maps.apple.com/?q=" + encodeURIComponent(q));
        }
      };

      if (hasStatic) {
        adaptPlatform();
        return;
      }

      if (!apiKey) {
        if (statusEl) statusEl.textContent = "Missing maps API key.";
        return;
      }
      if (!navigator.geolocation) {
        if (statusEl) statusEl.textContent = "Geolocation unsupported.";
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        try {
          const { latitude, longitude } = pos.coords;
          if (statusEl) statusEl.textContent = "Searching nearby…";
          const nearbyUrl =
            "https://maps.googleapis.com/maps/api/place/nearbysearch/json" +
            "?key=" + encodeURIComponent(apiKey) +
            "&location=" + latitude + "," + longitude +
            "&rankby=distance&type=golf_course";

          const resp = await fetch(nearbyUrl);
          if (!resp.ok) throw new Error("Places request failed");
          const data = await resp.json();
          const first = data.results && data.results[0];
          if (!first) {
            if (statusEl) statusEl.textContent = "No courses found.";
            return;
          }

          const mapsUrl = "https://www.google.com/maps/search/?api=1&query=" +
            encodeURIComponent(first.name) +
            "&query_place_id=" + first.place_id;

          btn.setAttribute("href", mapsUrl);
          if (statusEl) statusEl.textContent = "Nearest: " + first.name;
          adaptPlatform();
        } catch (e) {
          console.warn("Nearest course error:", e);
          if (statusEl) statusEl.textContent = "Lookup failed.";
        }
      }, err => {
        console.warn("Geolocation error:", err);
        if (statusEl) statusEl.textContent = "Location denied.";
      }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
    })();
  </script>
)}
