---
import { Table } from "~components/Table";
import { contentfulClient } from "~services/contentful/contentful";
import { contentfulCache } from "~utils/contentfulCache";
import { filterLeaderboardEntries, formatLeaderboardRows } from "~utils/contentfulTransformers";
import type { TypeLeadersSkeleton } from "~types/contentful";

const { gross, net, firstFlight, secondFlight, items } = Astro.props;
const shouldFetch = !Array.isArray(items) || items.length === 0;
const entries = shouldFetch
	? await contentfulCache.cached(
			async () =>
				contentfulClient.getEntries<TypeLeadersSkeleton>({
					content_type: "leaders",
					limit: 300,
					order: (gross && "fields.gross") || (net && "fields.net"),
				}),
			{ content_type: "leaders", gross, net, firstFlight, secondFlight },
			10 * 60 * 1000, // 10 minutes cache
		)
	: { items };
---

<Table
	thead={gross
		? ["Gross Leaders"]
		: net && firstFlight
			? ["Net Leaders First Flight"]
			: ["Net Leaders Second Flight"]}
	colSpan={2}
	tbody={(() => {
		const rows = filterLeaderboardEntries(entries.items, { gross, net, firstFlight, secondFlight });
		return formatLeaderboardRows(rows);
	})()}
/>
